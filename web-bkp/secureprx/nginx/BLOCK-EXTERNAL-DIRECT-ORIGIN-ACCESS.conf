# Header based origin protection
# Verify the requests coming through external vip has VMW-Vistor-ID header and correct value
#
# 10.188.246.98  secureproxy-scdc-stg-vip
# 10.128.40.65    secureproxy-wdc-stg-vip
# 10.188.245.166 secureproxy-scdc-prd-ext-vip-snat1.net.vmware.com
# 10.188.245.167 secureproxy-scdc-prd-ext-vip-snat2.net.vmware.com
# 10.128.42.46 secureproxy-wdc-prd-ext-vip-snat1.net.vmware.com
# 10.128.42.47 secureproxy-wdc-prd-ext-vip-snat2.net.vmware.com
# Nginx does not support nested or multiple tests inside if statement
# Use a variable $request_type to achive the same function.

if ( $remote_addr = '10.188.246.98' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $remote_addr = '10.188.245.166' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $remote_addr = '10.188.245.167' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $remote_addr = '10.128.40.65' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $remote_addr = '10.128.42.46' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $remote_addr = '10.128.42.47' ) {
    set $request_type 'ExtReqNotTrusted';
}

if ( $http_VMW_Visitor_ID = 'AKAMAI_vMkH3e6n' ) {
    set $request_type "${request_type}Trusted";
}

# Add more trusted header values here, add as much as needed:
#if ( $http_VMW_Visitor_ID = 'AKAMAI_c3M85w9z' ) {
#    set $request_type "${request_type}Trusted";
#}

if ( $request_type = 'ExtReqNotTrusted' ) {
    # Do a softblock (redirect)
    rewrite ^.*$  https://maintenance.vmware.com/info12.html;
}
