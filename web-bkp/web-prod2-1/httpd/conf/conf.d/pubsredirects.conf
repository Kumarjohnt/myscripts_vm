#Language Mapping

RewriteMap pubsmap "txt:/usr/local/apache/conf/conf.d/pubsmap.conf"
RewriteMap pubsmapapi "txt:/usr/local/apache/conf/conf.d/pubsmap-developer.conf"

# All individual specific rules related to pubs to code
Include conf/conf.d/pubstocode.conf

# All individual specific rules should be in this file
Include conf/conf.d/pubsrespecific.conf

#Redirect API Docs to code.vmware.com/sdks
RewriteCond ${pubsmapapi:$3} .+
RewriteCond ${pubsmapapi:$1} (.+)
RewriteRule ^/([^/]+)/(.+?(com.vmware.*?doc).*)$      /%1/$2 [R=301,L,NC]
#/vrealize-automation-73/index.jsp?topic=/com.vmware.vra.install.upgrade.doc/GUID-9A16E004-ED2B-43A7-9F52-8730E8C84297.html
RewriteCond %{QUERY_STRING} topic=.+?(com.vmware.*?doc)[^&]+
RewriteCond ${pubsmapapi:%1} .+
RewriteCond ${pubsmapapi:$1} (.+)
RewriteRule ^/([^/]+)/index.jsp$       /%1/index.jsp [R=301,L,NC,NE]

#Publications HTML5
#/vsphere-65/topic/com.vmware.psc.doc/GUID-3AF7757E-A30E-4EEC-8A41-28DA72102520.html
RewriteCond ${pubsmap:$1} .+
RewriteCond %{HTTP:Accept-Language} ^([a-z_-][^,]*)
RewriteCond ${pubsmap:%1|en} (.+)
RewriteRule ^/([^/]+)/topic/([^/]+)/([\-A-Z0-9]+.html)$       https://docs.vmware.com/%1/${pubsmap:$1}/$2/$3 [R=301,L,NC,QSD]


#Publications PDF
#/vsphere-65/topic/com.vmware.ICbase/PDF/vsphere-esxi-vcenter-server-65-monitoring-performance-guide.pdf
RewriteCond ${pubsmap:$1} .+
RewriteCond %{HTTP:Accept-Language} ^([a-z_-][^,]*)
RewriteCond ${pubsmap:%1|en} (.+)
RewriteRule ^/([^/]+)/topic/[^/]+/PDF/([^/]+.pdf)$ 	https://docs.vmware.com/%1/${pubsmap:$1}/$2 [R=301,L,NC,QSD]


#Without lang query string in the url
#/vrealize-automation-73/index.jsp?topic=/com.vmware.vra.install.upgrade.doc/GUID-9A16E004-ED2B-43A7-9F52-8730E8C84297.html
RewriteCond %{HTTP:Accept-Language} ^([a-z_-][^,]*)
RewriteCond ${pubsmap:%1|en} (.+)
RewriteCond %1##${pubsmap:$1} ([_a-zA-Z]+)##.+
RewriteCond %1##%{QUERY_STRING} ([_a-zA-Z]+)##topic=/([^/]+)/([\-A-Z0-9]+.html)
RewriteRule ^/([^/]+)/index.jsp$       https://docs.vmware.com/%1/${pubsmap:$1}/%2/%3 [R=301,L,NC,QSD,NE]


#Without lang query string in the url and with encoded url parameter
#/vrealize-automation-73/index.jsp?topic=/com.vmware.vra.install.upgrade.doc/GUID-9A16E004-ED2B-43A7-9F52-8730E8C84297.html
RewriteCond %{HTTP:Accept-Language} ^([a-z_-][^,]*)
RewriteCond ${pubsmap:%1|en} (.+)
RewriteCond %1##${pubsmap:$1} ([_a-zA-Z]+)##.+
RewriteCond %1##%{QUERY_STRING} ([_a-zA-Z]+)##topic=%2F([^%]+)%2F([\-A-Z0-9]+.html)
RewriteRule ^/([^/]+)/index.jsp$       https://docs.vmware.com/%1/${pubsmap:$1}/%2/%3 [R=301,L,NC,QSD,NE]


#Landing Page
#/vsphere-65/index.jsp
RewriteCond %{HTTP:Accept-Language} ^([a-z_-][^,]*)
RewriteCond ${pubsmap:%1|en} (.+)
RewriteCond %1##${pubsmap:$1} ([_a-zA-Z]+)##([_0-9\-a-zA-Z]+)/([^\s]+)
RewriteRule ^/([^/]+)/index.jsp$	https://docs.vmware.com/%1/%2/index.html [R=301,L,NC,QSD]


#Release Notes
#/Release_Notes/en/vsphere/65/vsphere-vcenter-server-650d-release-notes.html
RewriteCond ${pubsmap:$2} .+
RewriteCond ${pubsmap:$1} (.+)
RewriteRule ^/Release_Notes/([^/]+)/([^/]+/[^/]+)/([^/]+.html)$	https://docs.vmware.com/%1/${pubsmap:$2}/rn/$3 [R=301,L,NC,QSD]
#/Release_Notes/en/vsphere/vsphere-vcenter-server-650d-release-notes.html
RewriteCond ${pubsmap:$2} .+
RewriteCond ${pubsmap:$1} (.+)
RewriteRule ^/Release_Notes/([^/]+)/([^/]+)/([^/]+.html)$	https://docs.vmware.com/%1/${pubsmap:$2}/index.html [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-4
#/vsphere-65/context?id=com.vmware.vsphere.vm_admin.doc.vc_153&lang=en
RewriteCond ${pubsmap:$1} (.+)
RewriteCond %{QUERY_STRING}   id=([a-z_-][^,]*)&lang=([a-z_-][^,]*)
RewriteRule ^/([^/]+)/context$  https://docs.vmware.com/en/${pubsmap:$1}/context?id=%1  [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-4.1
#/vsphere-65/context?id=com%2Evmware%2Evsphere%2Evm%5Fadmin%2Edoc%2Evc%5F153&lang=en
RewriteCond ${pubsmap:$1} (.+)
RewriteCond %{QUERY_STRING}   id=.*%2E([\w_%5F-\d]+)$&lang=([a-z_-][^,]*)
RewriteRule ^/([^/]+)/context$  https://docs.vmware.com/en/${pubsmap:$1}/context?id=%1  [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-3
#/vsphere-65/context?lang=en&id=com.vmware.vsphere.vm_admin.doc.vc_153
RewriteCond ${pubsmap:$1} (.+)
RewriteCond %{QUERY_STRING}   lang=([a-z_-][^,]*)&id=([a-z_-][^,]*)
RewriteRule ^/([^/]+)/context$     https://docs.vmware.com/en/${pubsmap:$1}/context?id=%2  [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-3.1
#/vsphere-65/context?lang=en&id=com%2Evmware%2Evsphere%2Evm%5Fadmin%2Edoc%2Evc%5F153
RewriteCond ${pubsmap:$1} (.+)
RewriteCond %{QUERY_STRING}   lang=([a-z_-][^,]*)&id=.*%2E([\w_%5F-\d]+)$
RewriteRule ^/([^/]+)/context$  https://docs.vmware.com/en/${pubsmap:$1}/context?id=%2  [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-2
#/vsphere-55/context?id=com.vmware.vsphere.vm_admin.doc.vc_127
RewriteCond ${pubsmap:$1} .+
RewriteCond %{QUERY_STRING}   id=.*\.([\w_-\d]+)$
RewriteRule ^/([^/]+)/context$     https://docs.vmware.com/en/${pubsmap:$1}/context?id=%1 [R=301,L,NC,QSD]

#CSH redirect for Legacy rule-1
#/vsphere-55/context?id=vc_127
RewriteCond ${pubsmap:$1} .+
RewriteCond %{QUERY_STRING}  id=([\w_-\d]+)
RewriteRule ^/([^/]+)/context$     https://docs.vmware.com/en/${pubsmap:$1}/context?id=%1 [R=301,L,NC,QSD]



#/mirage-52/topic/com.vmware.mirage.interoperability.doc/GUID-445E25D2-3653-4CC0-B9D2-5D5E03A04584.html
RewriteRule ^/mirage-52/topic/com.vmware.mirage.interoperability.doc/GUID-445E25D2-3653-4CC0-B9D2-5D5E03A04584.html    https://docs.vmware.com   [R=301,L,NE]

#/view-50/topic/com.vmware.view.administration.doc/GUID-1F2D0C6E-6379-4B52-A7EA-C1EF09CE2F9B.html 
RewriteRule ^/view-50/topic/com.vmware.view.administration.doc/GUID-1F2D0C6E-6379-4B52-A7EA-C1EF09CE2F9B.html    https://docs.vmware.com   [R=301,L,NE]


RewriteRule   ^(.*)$     https://docs.vmware.com$1 [L,QSA,P]
